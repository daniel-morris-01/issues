name: Generate issue dashboard

on:
  issues:
concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true
jobs:
  generate-issues-html:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
      - name: Create output directory
        run: |
            mkdir -p out
      - name: 'Generate tier 1 Dashboard'
        uses: ./.github/actions/issue-dashboard
        with:
          config: |
            title: 'dashboard-t1'
            output:
              format: html
              filename: 'out/dashboard-t1.html'
            sections:
              - title: 'Open Issues'
                description: 'Tier 1'
                widgets:
                - type: 'number'
                  title: 'Needs Triage'
                  issue_query: 'repo:daniel-morris-01/issues is:open is:issue label:needs-triage'
                  color: 'red'
                - type: 'table'
                  title: 'Triage'
                  issue_query: 'repo:daniel-morris-01/issues is:open is:issue label:needs-triage sort:created-asc'
                - type: 'number'
                  title: 'Open Tier 1'
                  issue_query: 'repo:daniel-morris-01/issues is:open is:issue label:tier-1 -label:resolved'
                  color: 'yellow'
                - type: 'table'
                  title: 'Tier 1'
                  issue_query: 'repo:daniel-morris-01/issues is:open is:issue label:tier-1 -label:resolved sort:created-asc'
          token: ${{ github.token }}
      - name: 'Generate tier 2 Dashboard'
        uses: ./.github/actions/issue-dashboard
        with:
          config: |
            title: 'dashboard-t2'
            output:
              format: html
              filename: 'out/dashboard-t2.html'
            sections:
              - title: 'Open Issues'
                description: 'Tier 2'
                widgets:
                - type: 'number'
                  title: 'Open Tier 2'
                  issue_query: 'repo:daniel-morris-01/issues is:open is:issue label:tier-2 -label:resolved'
                  color: 'red'
                - type: 'table'
                  title: 'Tier 2'
                  issue_query: 'repo:daniel-morris-01/issues is:open is:issue label:tier-2 -label:resolved  sort:created-asc'
          token: ${{ github.token }}
      - name: Setup Pages
        uses: actions/configure-pages@v5
      - name: Upload pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          # Upload output directory
          path: './out/'
  deploy:
    needs: generate-issues-html
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4